/*!
 * libTroxel (https://github.com/chrmoritz/Troxel)
 * Copyright 2014 Christian Moritz
 * Licensed under GNU LGPL v3.0 (https://github.com/chrmoritz/Troxel/blob/master/LICENSE.txt)
 */
!function(){(function(){var t;t=function(){function t(e){return e instanceof t||"object"==typeof e&&null!=e.x&&null!=e.y&&null!=e.z&&null!=e.voxels?(this.voxels=e.voxels,this.x=e.x,this.y=e.y,this.z=e.z,!0):void 0}return t.prototype.verify=function(){var t,e,i,s,o,n,r,h,l,a,c,u,d,p,v,x;if(null==this.x||null==this.y||null==this.z||null==this.voxels)return!1;if(!(this.x>0&&this.y>0&&this.z>0&&Array.isArray(this.voxels)))return!1;if(this.voxels.length>this.z)return!1;for(a=this.voxels,s=0,r=a.length;r>s;s++){if(i=a[s],!Array.isArray(i)||i.length>this.y)return!1;for(o=0,h=i.length;h>o;o++){if(e=i[o],!Array.isArray(e)||e.length>this.x)return!1;for(n=0,l=e.length;l>n;n++){if(t=e[n],"object"!=typeof t)return!1;if(!("number"==typeof t.r&&0<=(c=t.r)&&255>=c))return!1;if(!("number"==typeof t.g&&0<=(u=t.g)&&255>=u))return!1;if(!("number"==typeof t.b&&0<=(d=t.b)&&255>=d))return!1;if(!("number"==typeof t.a&&0<=(p=t.a)&&255>=p))return!1;if("number"!=typeof t.t||!(0<=(v=t.t)&&4>=v||7===t.t))return!1;if("number"!=typeof t.s||!(0<=(x=t.s)&&3>=x||7===t.s))return!1}}}return!0},t.prototype.rotateX=function(t){var e,i,s,o,n,r,h,l,a,c,u,d,p;for(e=this.voxels.slice(0),this.voxels=[],o=n=0,l=this.z;l>n;o=n+=1)for(s=r=0,a=this.y;a>r;s=r+=1)for(i=h=0,c=this.x;c>h;i=h+=1)null!=(null!=(u=e[t?this.z-o-1:o])&&null!=(d=u[t?s:this.y-s-1])?d[i]:void 0)&&(null==this.voxels[s]&&(this.voxels[s]=[]),null==this.voxels[s][o]&&(this.voxels[s][o]=[]),this.voxels[s][o][i]=e[t?this.z-o-1:o][t?s:this.y-s-1][i]);return p=[this.y,this.z],this.z=p[0],this.y=p[1],p},t.prototype.rotateY=function(t){var e,i,s,o,n,r,h,l,a,c,u,d,p;for(e=this.voxels.slice(0),this.voxels=[],o=n=0,l=this.z;l>n;o=n+=1)for(s=r=0,a=this.y;a>r;s=r+=1)for(i=h=0,c=this.x;c>h;i=h+=1)null!=(null!=(u=e[t?this.z-o-1:o])&&null!=(d=u[s])?d[t?i:this.x-i-1]:void 0)&&(null==this.voxels[i]&&(this.voxels[i]=[]),null==this.voxels[i][s]&&(this.voxels[i][s]=[]),this.voxels[i][s][o]=e[t?this.z-o-1:o][s][t?i:this.x-i-1]);return p=[this.x,this.z],this.z=p[0],this.x=p[1],p},t.prototype.rotateZ=function(t){var e,i,s,o,n,r,h,l,a,c,u,d,p;for(e=this.voxels.slice(0),this.voxels=[],o=n=0,l=this.z;l>n;o=n+=1)for(s=r=0,a=this.y;a>r;s=r+=1)for(i=h=0,c=this.x;c>h;i=h+=1)null!=(null!=(u=e[o])&&null!=(d=u[t?s:this.y-s-1])?d[t?this.x-i-1:i]:void 0)&&(null==this.voxels[o]&&(this.voxels[o]=[]),null==this.voxels[o][i]&&(this.voxels[o][i]=[]),this.voxels[o][i][s]=e[o][t?s:this.y-s-1][t?this.x-i-1:i]);return p=[this.x,this.y],this.y=p[0],this.x=p[1],p},t.prototype.mirrorX=function(){var t,e,i,s,o,n,r;for(t=this.voxels.slice(0),this.voxels=[],r=[],s=o=0,n=this.z;n>o;s=o+=1)r.push(function(){var o,n,r;for(r=[],i=o=0,n=this.y;n>o;i=o+=1)r.push(function(){var o,n,r,h,l;for(l=[],e=o=0,n=this.x;n>o;e=o+=1)null!=(null!=(r=t[s])&&null!=(h=r[i])?h[this.x-e-1]:void 0)&&(null==this.voxels[s]&&(this.voxels[s]=[]),null==this.voxels[s][i]&&(this.voxels[s][i]=[]),l.push(this.voxels[s][i][e]=t[s][i][this.x-e-1]));return l}.call(this));return r}.call(this));return r},t.prototype.mirrorY=function(){var t,e,i,s,o,n,r;for(t=this.voxels.slice(0),this.voxels=[],r=[],s=o=0,n=this.z;n>o;s=o+=1)r.push(function(){var o,n,r;for(r=[],i=o=0,n=this.y;n>o;i=o+=1)r.push(function(){var o,n,r,h,l;for(l=[],e=o=0,n=this.x;n>o;e=o+=1)null!=(null!=(r=t[s])&&null!=(h=r[this.y-i-1])?h[e]:void 0)&&(null==this.voxels[s]&&(this.voxels[s]=[]),null==this.voxels[s][i]&&(this.voxels[s][i]=[]),l.push(this.voxels[s][i][e]=t[s][this.y-i-1][e]));return l}.call(this));return r}.call(this));return r},t.prototype.mirrorZ=function(){var t,e,i,s,o,n,r;for(t=this.voxels.slice(0),this.voxels=[],r=[],s=o=0,n=this.z;n>o;s=o+=1)r.push(function(){var o,n,r;for(r=[],i=o=0,n=this.y;n>o;i=o+=1)r.push(function(){var o,n,r,h,l;for(l=[],e=o=0,n=this.x;n>o;e=o+=1)null!=(null!=(r=t[this.z-s-1])&&null!=(h=r[i])?h[e]:void 0)&&(null==this.voxels[s]&&(this.voxels[s]=[]),null==this.voxels[s][i]&&(this.voxels[s][i]=[]),l.push(this.voxels[s][i][e]=t[this.z-s-1][i][e]));return l}.call(this));return r}.call(this));return r},t}(),"object"==typeof module?module.exports=t:window.IO=t}).call(this),function(){var t,e,i={}.hasOwnProperty,s=function(t,e){function s(){this.constructor=t}for(var o in e)i.call(e,o)&&(t[o]=e[o]);return s.prototype=e.prototype,t.prototype=new s,t.__super__=e.prototype,t},o=[].slice;t=function(t){function e(t){var i,s,n,r,h,l,a,c,u,d,p,v,x,f;if(!e.__super__.constructor.call(this,t)){for(this.voxels=[],p=atob(t).split("").map(function(t){return t.charCodeAt(0)}),this.x=p[0],this.y=p[1],this.z=p[2],this.readonly=p[3],i=5<=p.length?o.call(p,4):[],s=n=0,r={},a=c=0,v=this.z;v>c;a=c+=1)for(l=u=0,x=this.y;x>u;l=u+=1)for(h=d=0,f=this.x;f>d;h=d+=1){if(0===n){if(i[s]>127?(n=i[s]-127,s++):n=1,i[s]>127)throw new Error("Base64 parsing error");i[s]<64?(r={r:i[s+1],g:i[s+2],b:i[s+3],a:i[s+4],s:i[s]%8,t:i[s]>>3},s+=5):(r=null,s++)}null!=r&&(null==this.voxels[a]&&(this.voxels[a]=[]),null==this.voxels[a][l]&&(this.voxels[a][l]=[]),this.voxels[a][l][h]=r),n--}s!==i.length&&console.warn("There shouldn't be any bytes left"),this.readonly||console.log("voxels:"),this.readonly||console.log(this.voxels)}}return s(e,t),e.prototype.export=function(t){var e,i,s,o,n,r,h,l,a,c,u,d,p,v,x,f;for(i=function(t,e,i){var s,o,r,h;if(!(i<n.length))return!1;if(null==t&&null==e)return!0;if(null==t||null==e)return!1;for(h=["r","g","b","a","t","s"],o=0,r=h.length;r>o;o++)if(s=h[o],t[s]!==e[s])return!1;return!0},e=[this.x,this.y,this.z,t?1:0],n=[],l=a=0,d=this.z;d>a;l=a+=1)for(h=c=0,p=this.y;p>c;h=c+=1)for(r=u=0,v=this.x;v>u;r=u+=1)n.push(null!=(x=this.voxels[l])&&null!=(f=x[h])?f[r]:void 0);for(s=0;s<n.length;){for(o=1;128>o&&i(n[s+o-1],n[s+o],s+o);)o++;o>1&&e.push(127+o),null!=n[s]?e=e.concat([8*n[s].t+n[s].s,n[s].r,n[s].g,n[s].b,n[s].a]):e.push(64),s+=o}return console.log("export base64:"),console.log(e),btoa(String.fromCharCode.apply(null,e))},e}(IO),e=function(t){function e(t){var i;e.__super__.constructor.call(this,t)||(i=JSON.parse(t),this.x=i.x,this.y=i.y,this.z=i.z,this.voxels=i.voxels)}return s(e,t),e.prototype.export=function(t){return JSON.stringify({x:this.x,y:this.y,z:this.z,voxels:this.voxels},null,t?"    ":"")},e}(IO),("undefined"!=typeof exports&&null!==exports?exports:window).Base64IO=t,("undefined"!=typeof exports&&null!==exports?exports:window).JsonIO=e}.call(this),function(){var t;t=function(){function t(t,e,i){var s,o,n,r,h,l,a,c,u,d,p,v,x,f,y,m,E,b,w,g,z,R;for(this.embedded=null!=e?e:!1,this.domContainer=null!=i?i:$("#WebGlContainer"),this.voxels=t.voxels,this.x=t.x,this.y=t.y,this.z=t.z,this.objects=[],this.width=this.domContainer.width(),this.height=this.embedded?this.domContainer.height():window.innerHeight-55,this.scene=new THREE.Scene,n=new THREE.BoxGeometry(50,50,50),r=new THREE.MeshBasicMaterial({color:16711680,opacity:.5,transparent:!0}),this.rollOverMesh=new THREE.Mesh(n,r),this.scene.add(this.rollOverMesh),s=new THREE.Geometry,c=u=0,y=this.z;y>=u;c=u+=1)s.vertices.push(new THREE.Vector3(0,0,50*c)),s.vertices.push(new THREE.Vector3(50*this.x,0,50*c)),s.vertices.push(new THREE.Vector3(50*this.x,0,50*c)),s.vertices.push(new THREE.Vector3(50*this.x,50*this.y,50*c));for(l=d=0,m=this.x;m>=d;l=d+=1)s.vertices.push(new THREE.Vector3(50*l,0,0)),s.vertices.push(new THREE.Vector3(50*l,0,50*this.z)),s.vertices.push(new THREE.Vector3(50*l,0,0)),s.vertices.push(new THREE.Vector3(50*l,50*this.y,0));for(a=p=0,E=this.y;E>=p;a=p+=1)s.vertices.push(new THREE.Vector3(0,50*a,0)),s.vertices.push(new THREE.Vector3(50*this.x,50*a,0)),s.vertices.push(new THREE.Vector3(50*this.x,50*a,0)),s.vertices.push(new THREE.Vector3(50*this.x,50*a,50*this.z));for(o=new THREE.LineBasicMaterial({color:0,opacity:.2,transparent:!0}),this.grid=new THREE.Line(s,o,THREE.LinePieces),this.scene.add(this.grid),s=new THREE.PlaneBufferGeometry(50*this.x,50*this.z),s.applyMatrix((new THREE.Matrix4).makeRotationX(-Math.PI/2)),this.plane=new THREE.Mesh(s),this.plane.position.x=25*this.x,this.plane.position.z=25*this.z,this.plane.visible=!1,this.scene.add(this.plane),this.objects.push(this.plane),this.vector=new THREE.Vector3,this.raycaster=new THREE.Raycaster,c=v=0,b=this.z;b>v;c=v+=1)for(a=x=0,w=this.y;w>x;a=x+=1)for(l=f=0,g=this.x;g>f;l=f+=1)null!=(null!=(z=this.voxels[c])&&null!=(R=z[a])?R[l]:void 0)&&(o=new THREE.MeshLambertMaterial({color:new THREE.Color("rgb("+this.voxels[c][a][l].r+","+this.voxels[c][a][l].g+","+this.voxels[c][a][l].b+")"),shading:THREE.FlatShading}),o.ambient=o.color,this.voxels[c][a][l].a<255&&(o.transparent=!0,o.opacity=this.voxels[c][a][l].a/255),h=new THREE.Mesh(new THREE.BoxGeometry(50,50,50),o),h.position.x=50*l+25,h.position.y=50*a+25,h.position.z=50*c+25,this.scene.add(h),this.objects.push(h));this.ambientLight=new THREE.AmbientLight(6316128),this.scene.add(this.ambientLight),this.directionalLight=new THREE.DirectionalLight(16777215),this.directionalLight.position.set(1,.75,.5).normalize(),this.scene.add(this.directionalLight),this.renderer=new THREE.WebGLRenderer({antialias:!0}),this.renderer.setClearColor(8947848),this.renderer.setSize(this.width,this.height),this.domContainer.empty().append(this.renderer.domElement),this.domContainer.on("mousedown",function(t){return function(e){return t.onDocumentMouseDown(e)}}(this)),this.domContainer.on("mousemove",function(t){return function(e){return t.onDocumentMouseMove(e)}}(this)),document.addEventListener("keydown",function(t){return function(e){return t.onDocumentKeyDown(e)}}(this)),document.addEventListener("keyup",function(t){return function(e){return t.onDocumentKeyUp(e)}}(this)),window.addEventListener("resize",function(t){return function(e){return t.onWindowResize(e)}}(this)),this.embedded||(this.stats=new Stats,this.stats.domElement.style.position="absolute",this.stats.domElement.style.top="0px",this.domContainer.append(this.stats.domElement)),this.camera=new THREE.PerspectiveCamera(45,this.width/this.height,1,1e4),this.camera.position.y=50*this.y,this.camera.position.x=-75*this.x,this.camera.position.z=25*this.z,this.controls=new THREE.OrbitControls(this.camera,this.domContainer[0]),this.controls.target=new THREE.Vector3(25*this.x,25*this.y,25*this.z),this.controls.addEventListener("change",function(t){return function(){return t.render()}}(this)),this.controls.enabled=!1,this.changeEditMode($("#modeEdit").parent().hasClass("active")),this.animate(),this.render()}return t.prototype.reload=function(t){var e,i,s,o,n,r,h,l,a,c,u,d,p,v,x,f,y;for(this.voxels=t.voxels,this.x=t.x,this.y=t.y,this.z=t.z,d=this.objects,h=0,u=d.length;u>h;h++)i=d[h],i!==this.plane&&this.scene.remove(i);for(this.objects=[this.plane],r=l=0,p=this.z;p>l;r=l+=1)for(n=a=0,v=this.y;v>a;n=a+=1)for(o=c=0,x=this.x;x>c;o=c+=1)null!=(null!=(f=this.voxels[r])&&null!=(y=f[n])?y[o]:void 0)&&(e=new THREE.MeshLambertMaterial({color:new THREE.Color("rgb("+this.voxels[r][n][o].r+","+this.voxels[r][n][o].g+","+this.voxels[r][n][o].b+")"),shading:THREE.FlatShading}),e.ambient=e.color,this.voxels[r][n][o].a<255&&(e.transparent=!0,e.opacity=this.voxels[r][n][o].a/255),s=new THREE.Mesh(new THREE.BoxGeometry(50,50,50),e),s.position.x=50*o+25,s.position.y=50*n+25,s.position.z=50*r+25,this.scene.add(s),this.objects.push(s));return this.render()},t.prototype.changeEditMode=function(t){return this.editMode=t,this.editMode?(this.grid.visible=!0,this.rollOverMesh.visible=!0,this.controls.enabled=!1):(this.grid.visible=!1,this.rollOverMesh.visible=!1,this.controls.enabled=!0),this.render()},t.prototype.animate=function(){return requestAnimationFrame(function(t){return function(){return t.animate()}}(this)),this.controls.update(),this.embedded?void 0:this.stats.update()},t.prototype.render=function(t){return this.renderer.render(this.scene,this.camera),t?window.open(this.renderer.domElement.toDataURL("image/png"),"Exported png"):void 0},t.prototype.onDocumentMouseMove=function(t){var e,i;if(this.editMode&&"block"!==$("#openModal").css("display")&&"block"!==$("#exportModal").css("display")&&"block"!==$("#saveModal").css("display"))return t.preventDefault(),this.vector.set(t.clientX/this.width*2-1,2*-((t.clientY-50)/this.height)+1,.5),this.vector.unproject(this.camera),this.raycaster.ray.set(this.camera.position,this.vector.sub(this.camera.position).normalize()),i=this.raycaster.intersectObjects(this.objects),i.length>0&&(e=i[0],this.rollOverMesh.position.copy(e.point).add(e.face.normal),this.rollOverMesh.position.divideScalar(50).floor().multiplyScalar(50).addScalar(25)),this.render()},t.prototype.onDocumentMouseDown=function(t){var e,i,s,o,n,r,h,l;if(this.editMode&&"block"!==$("#openModal").css("display")&&"block"!==$("#exportModal").css("display")&&"block"!==$("#saveModal").css("display")&&(this.vector.set(t.clientX/this.width*2-1,2*-((t.clientY-50)/this.height)+1,.5),this.vector.unproject(this.camera),this.raycaster.ray.set(this.camera.position,this.vector.sub(this.camera.position).normalize()),o=this.raycaster.intersectObjects(this.objects),o.length>0)){if(s=o[0],2===t.button&&s.object!==this.plane&&(r=(s.object.position.x-25)/50,h=(s.object.position.y-25)/50,l=(s.object.position.z-25)/50,delete this.voxels[l][h][r],0===this.voxels[l][h].filter(function(t){return void 0!==t}).length&&delete this.voxels[l][h],0===this.voxels[l].filter(function(t){return void 0!==t}).length&&delete this.voxels[l],this.scene.remove(s.object),this.objects.splice(this.objects.indexOf(s.object),1)),0===t.button){if(i=new THREE.MeshLambertMaterial({color:new THREE.Color($("#addVoxColor").val()),shading:THREE.FlatShading}),i.ambient=i.color,e=parseInt($("#addVoxAlpha").val()),272===e&&(e=255),255>e&&(i.transparent=!0,i.opacity=e/255),n=new THREE.Mesh(new THREE.BoxGeometry(50,50,50),i),n.position.copy(s.point).add(s.face.normal),n.position.divideScalar(50).floor().multiplyScalar(50).addScalar(25),r=(n.position.x-25)/50,h=(n.position.y-25)/50,l=(n.position.z-25)/50,!(r>=0&&r<this.x&&h>=0&&h<this.y&&l>=0&&l<this.z))return;null==this.voxels[l]&&(this.voxels[l]=[]),null==this.voxels[l][h]&&(this.voxels[l][h]=[]),this.voxels[l][h][r]={r:parseInt($("#addVoxColor").val().substring(1,3),16),g:parseInt($("#addVoxColor").val().substring(3,5),16),b:parseInt($("#addVoxColor").val().substring(5,7),16),a:e,t:parseInt($("#addVoxType").val()),s:parseInt($("#addVoxSpecular").val())},this.scene.add(n),this.objects.push(n)}return this.render()}},t.prototype.onDocumentKeyDown=function(t){if(1!==$(".active #modeView").length)switch(t.keyCode){case 18:return this.controls.enabled=!0,this.editMode=!1}},t.prototype.onDocumentKeyUp=function(t){if(1!==$(".active #modeView").length)switch(t.keyCode){case 18:return this.controls.enabled=!1,this.editMode=!0}},t.prototype.onWindowResize=function(){return this.width=this.domContainer.width(),this.height=this.embedded?this.domContainer.height():window.innerHeight-55,this.camera.aspect=this.width/this.height,this.camera.updateProjectionMatrix(),this.renderer.setSize(this.width,this.height),this.render()},t}(),"object"==typeof module?module.exports=t:window.Renderer=t}.call(this),function(){window.Troxel={webgl:function(){var t;try{return t=document.createElement("canvas"),!(!window.WebGLRenderingContext||!t.getContext("webgl"))}catch(t){return!1}},renderBlueprint:function(t,e,i){return $.ajax({dataType:"jsonp",url:"https://chrmoritz.github.io/Troxel/static/Trove.jsonp",jsonpCallback:"callback",success:function(s){var o;return o=s[t],null!=o?Troxel.renderBase64(o,e,i,t):console.warn("blueprintId "+t+" not found")}})},renderBase64:function(t,e,i,s){var o,n;return null==i&&(i={}),Troxel.webgl()?(this.domElement=$(e).empty().css("position","relative"),this.io=new Base64IO(t),this.renderer=new Renderer(this.io,!0,this.domElement),null!=i.rendererClearColor&&this.renderer.renderer.setClearColor(i.rendererClearColor),null!=i.ambientLightColor&&(this.renderer.ambientLight.color=new THREE.Color(i.ambientLightColor)),null!=i.directionalLightColor&&(this.renderer.directionalLight.color=new THREE.Color(i.directionalLightColor)),null!=i.directionalLightIntensity&&(this.renderer.directionalLight.intensity=i.directionalLightIntensity),null!=i.directionalLightVector&&null!=i.directionalLightVector.x&&null!=i.directionalLightVector.y&&null!=i.directionalLightVector.z&&this.renderer.directionalLight.position.set(i.directionalLightVector.x,i.directionalLightVector.y,i.directionalLightVector.z).normalize(),(null==i.autoRotate||i.autoRotate)&&(this.renderer.controls.autoRotate=!0,null!=i.autoRotateSpeed&&(this.renderer.controls.autoRotateSpeed=i.autoRotateSpeed)),null==i.showInfoLabel||i.showInfoLabel?(n=null!=s?"#b="+s:"#m="+t,o=$("<div><a href='http://chrmoritz.github.io/Troxel/"+n+"' target='_blank' class='troxelLink'>Open this model in Troxel</a></div>"),this.domElement.append(o.css({position:"absolute",bottom:"0px",width:"100%",textAlign:"center"}))):void 0):console.warn("WebGL is not supported by your browser")}}}.call(this)}();